general:
  branches:
    ignore:
      - gh-pages
dependencies:
  override:
    - make -v
    - nvm install 4.3.2
    - nvm install 6
    - nvm use 6 && nvm alias default 6
    - which node
    # TODO test kpm with node_modules installed via npm2, npm3 and latest stable kpm
    - npm install
    - go get github.com/tcnksm/ghr
test:
  override:
    - nvm use 4.3.2 && nvm alias default 4.3.2
    - node -v
    - make test-ci
    - nvm use 6 && nvm alias default 6
    - node -v
    - make test-ci
    - make build-dist
deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    owner: facebook
    commands:
      - ghr --username facebook --repository fbkpm --token $KPM_CIRCLE_RELEASE_TOKEN v$(node dist/bin/kpm --version) dist/kpm-v*.tar.gz
